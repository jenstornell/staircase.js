const staircase={add(e,t){(new StaircaseCore).add(e,t)},delete(e){(new StaircaseCore).delete(e)},rename(e,t){(new StaircaseCore).rename(e,t)},select(e,t=!0){(new StaircaseCore).select(e,t)},deselect(e=!0){(new StaircaseCore).deselect(e)},open(e){(new StaircaseCore).open(e)},close(e){(new StaircaseCore).close(e)},refresh(e){(new StaircaseCore).refresh(e)}};class StaircaseCore{options(){let e=this.$("body").dataset.staircaseSelector,t=this.$(e).dataset;this.o={},this.o.selector=e;for(let e in t)this.o[e.substr(9).toLowerCase()]=t[e]}init(){this.options(),this.$(this.o.selector).dataset.scName="/",this.ajax("/")}$(e,t=null){return t?t.querySelector(e):document.querySelector(e)}$$(e,t=null){return t?t.querySelectorAll(e):document.querySelectorAll(e)}ajax(e){let t=e,s="",a={};e="object"==typeof e?t.shift():e,a.id=e,s=JSON.stringify(a);let i=this.item(e);if(void 0===i.dataset.scChildren)i.classList.add("sc-loading"),fetch(this.o.path,this.fetchParams(s)).then(e=>e.text()).then(s=>{i.classList.remove("sc-loading");let a={};if(a.id=e,a.element=i,this.isJson(s)){let t=this.createList(e,JSON.parse(s)),i=this.item(e);i.appendChild(t),this.children(i),this.state(i,"open"),this.ajaxClickName(e),this.ajaxClickFolder(i),this.ajaxClickToggle(i),a.success=!0}else a.success=!1;if("/"==a.id?this.callback("load",a):this.callback("toggle",a),a.success&&t&&t.length&&"object"==typeof t){let e=this.$(this.o.selector+' [data-sc-name="'+t[0]+'"]');this.hasChildren(e)||this.ajax(t)}});else{if(this.state(i,"open"),!t.length)return;this.ajax(t)}}fetchParams(e){return{method:"POST",headers:{"Content-Type":"application/json"},body:e}}callback(e,t={}){if("function"==typeof StaircaseCallbacks){let s=new StaircaseCallbacks;"function"==typeof s[e]&&s[e](t)}}state(e,t){e.dataset.scState=t}children(e){e.dataset.scChildren=""}hasChildren(e){return void 0!==e.dataset.scChildren}refresh(e){this.options();let t=this.item(e);t&&"open"===t.dataset.scState&&(t.remove(this.dirname(e)),this.add(e,"folder"),this.open(e))}add(e,t){this.options();let s=this.$('[data-sc-name="'+this.dirname(e)+'"] > [data-sc-children]');if(!s)return;if(this.item(e))return;let a=this.append(e,t);s.appendChild(a),this.onClickName(this.$(".sc-name",a)),this.onClickFolder(this.$(".sc-icon",a)),this.sort(s)}delete(e){this.options();let t=this.item(e);t&&t.remove()}rename(e,t){this.options();let s=this.item(e);if(!s)return;let a=e.slice(0,e.lastIndexOf("/")+1)+t;this.$(".sc-name",s).innerHTML=t,s.dataset.scName=a,this.sort(s.closest("ul"))}close(e){let t=this.$('[data-sc-name="'+e+'"]');this.state(t,"close"),this.callback("toggle",this.setData(t))}open(e){this.options();let t=e.split("/"),s="",a=[];for(let e in t)s+=t[e]+"/",a[e]=this.trimSlashes(s);this.ajax(a)}select(e,t){this.options();let s=this.item(e),a=this.setData(s);this.removeActive(),this.setActive(s),t&&this.callback("select",a)}deselect(e){this.options(),this.removeActive(),e&&this.callback("select")}basename(e){return e.replace(/.*\//,"")}dirname(e){let t=e.match(/.*\//);return t&&t.length?this.trimSlashes(t[0]):"/"}item(e){let t=this.o.selector;return t+="/"===e?'[data-sc-name="/"]':' [data-sc-name="'+e+'"]',this.$(t)}sort(e){let t=this.$$("li",e);[].slice.call(t).sort(function(e,t){var s=e.getAttribute("data-sc-name"),a=t.getAttribute("data-sc-name"),i=e.getAttribute("data-sc-type");return i!=t.getAttribute("data-sc-type")?"folder"==i?-1:1:s<a?-1:s>a?1:0}).forEach(function(e){e.parentNode.appendChild(e)})}append(e,t){let s=this.createLi(this.basename(e));return s.dataset.scType=t,s.dataset.scName=e,s}isJson(e){try{JSON.parse(e)}catch(e){return!1}return!0}createList(e,t){let s=document.createElement("ul"),a=this.toFilesFolders(t);return this.children(s),a.folders.forEach(t=>{let a=this.join(e,t),i=this.append(a,"folder");s.appendChild(i)}),a.files.forEach(t=>{let a=this.join(e,t),i=this.append(a,"file");s.appendChild(i)}),s}join(e,t){return this.trimSlashes(e+"/"+t)}createLi(e){let t=document.createElement("li"),s=document.createElement("div"),a=document.createElement("div"),i=document.createElement("div"),c=document.createTextNode(e);return a.classList.add("sc-icon"),i.classList.add("sc-name"),s.classList.add("sc-current"),i.appendChild(c),s.appendChild(a),s.appendChild(i),t.appendChild(s),t}toFilesFolders(e){let t=[];t.folders=[],t.files=[];let s=0;return e.forEach(e=>{this.isFolder(e)?t.folders[s]=e.slice(0,-1):t.files[s]=e,s++}),t.folders.sort(),t.files.sort(),t}isFolder(e){return"/"==e[e.length-1]}onClickName(e){e.addEventListener("click",e=>{let t=e.currentTarget.closest("li"),s=this.setData(t);this.removeActive(),this.setActive(t),this.callback("select",s)})}onClickToggle(e){e.addEventListener("click",e=>{let t=e.currentTarget.closest("li"),s=t.closest("li"),a=s.dataset.scState,i=this.setData(t);"open"==a?this.state(s,"close"):this.state(s,"open"),i.state=s.dataset.scState,this.callback("toggle",i)})}onClickFolder(e){e.addEventListener("click",e=>{let t=e.currentTarget.closest("[data-sc-name]");if(!this.hasChildren(t)){let e=t.dataset.scName,s=this.trimSlashes(e);this.ajax(s)}})}ajaxClickName(e){let t=this.o.selector+'[data-sc-name="'+e+'"] > ul > li > .sc-current > .sc-name'+", "+(this.o.selector+' [data-sc-name="'+e+'"] > ul > li > .sc-current > .sc-name');this.$$(t).forEach(e=>{this.onClickName(e)})}ajaxClickToggle(e){let t=e.dataset.scName,s=this.$(this.o.selector+'[data-sc-name="'+t+'"] > .sc-current > .sc-icon,'+this.o.selector+' [data-sc-name="'+t+'"] > .sc-current > .sc-icon');s&&this.onClickToggle(s)}ajaxClickFolder(e){this.$$('li[data-sc-type="folder"]:not([data-sc-children]) .sc-icon',e).forEach(e=>{this.onClickFolder(e)})}trimSlashes(e){return e.replace(/^\/+|\/+$/g,"")}setData(e){let t={};return t.id=e.dataset.scName,t.element=e,t.type=e.dataset.scType,t}removeActive(){this.options(),this.$$(this.o.selector+" li").forEach(function(e){delete e.dataset.scActive})}setActive(e){e.dataset.scActive=""}}document.addEventListener("DOMContentLoaded",()=>{(new StaircaseCore).init()});
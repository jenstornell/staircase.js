class staircase{static add(e,t,s){(new StaircaseCore).add(e,t,s)}static delete(e,t){(new StaircaseCore).delete(e,t)}static rename(e,t,s){(new StaircaseCore).rename(e,t,s)}static select(e,t){(new StaircaseCore).select(e,t)}static deselect(e,t){(new StaircaseCore).deselect(e,t)}static open(e){(new StaircaseCore).open(e)}static close(e){(new StaircaseCore).close(e)}}class StaircaseCore{options(){let e=this.$("body").dataset.staircaseSelector,t=this.$(e).dataset;this.o={},this.o.selector=e;for(let e in t)this.o[e.substr(9).toLowerCase()]=t[e]}load(){this.options(),this.$(this.o.selector).dataset.scName="/",this.ajax("/")}$(e,t=null){return t?t.querySelector(e):document.querySelector(e)}$$(e,t=null){return t?t.querySelectorAll(e):document.querySelectorAll(e)}ajax(e){let t=e,s={};"object"==typeof e?(e=t.shift(),s.id=e):"string"==typeof e&&(s.id=e);let a=JSON.stringify(s),c=this.$(this.o.selector+'[data-sc-name="'+e+'"], '+this.o.selector+' [data-sc-name="'+e+'"]');if(void 0===c.dataset.scChildren)c.classList.add("sc-loading"),fetch(this.o.path,this.fetchParams(a)).then(e=>e.text()).then(s=>{c.classList.remove("sc-loading");let a={};if(a.id=e,a.element=c,this.isJson(s)){let t=JSON.parse(s),c=this.createList(t,e),i=this.$(this.o.selector+'[data-sc-name="'+e+'"],'+this.o.selector+' [data-sc-name="'+e+'"]');i.appendChild(c),i.dataset.scChildren="",i.dataset.scState="open",this.ajaxClickName(e),this.ajaxClickFolder(i),this.ajaxClickToggle(i),a.success=!0}else a.success=!1;if("/"==a.id?this.callback("load",a):this.callback("toggle",a),a.success&&t&&t.length&&"object"==typeof t){void 0===this.$(this.o.selector+' [data-sc-name="'+t[0]+'"]').dataset.scChildren&&this.ajax(t)}});else{if(c.dataset.scState="open",!t.length)return;this.ajax(t)}}fetchParams(e){return{method:"POST",headers:{"Content-Type":"application/json"},body:e}}callback(e,t={}){if("function"==typeof StaircaseCallbacks){let s=new StaircaseCallbacks;"function"==typeof s[e]&&s[e](t)}}add(e,t,s){this.options();let a=this.$('[data-sc-name="'+e+'"] > [data-sc-children]'),c=this.append(e,t,s),i=this.$(".sc-name",c),l=this.$(".sc-icon",c);a.appendChild(c),this.onClickName(i),this.onClickFolder(l),this.sort(a)}delete(e,t){this.$('[data-sc-name="'+e+'"][data-sc-type="'+t+'"]').remove()}rename(e,t,s){let a=this.$('[data-sc-name="'+e+'"][data-sc-type="'+s+'"]'),c=e.slice(0,e.lastIndexOf("/")+1)+t;this.$(".sc-name",a).innerHTML=t,a.dataset.scName=c,this.sort(a.closest("ul"))}close(e){let t=this.$('[data-sc-name="'+e+'"]');t.dataset.scState="close",this.callback("toggle",this.setData(t))}open(e){this.options();let t=e.split("/"),s="",a=[];for(let e in t)s+=t[e]+"/",a[e]=this.trimSlashes(s);this.ajax(a)}select(e,t){this.options();let s=this.$('[data-sc-name="'+e+'"][data-sc-type="'+t+'"]'),a=this.setData(s);this.removeActive(),this.setActive(s),this.callback("select",a)}deselect(){this.options(),this.removeActive(),this.callback("select")}sort(e){let t=this.$$("li",e);[].slice.call(t).sort(function(e,t){var s=e.getAttribute("data-sc-name"),a=t.getAttribute("data-sc-name"),c=e.getAttribute("data-sc-type");return c!=t.getAttribute("data-sc-type")?"folder"==c?-1:1:s<a?-1:s>a?1:0}).forEach(function(e){e.parentNode.appendChild(e)})}append(e,t,s){let a=this.createLi(t),c=this.trimSlashes(e+"/"+t);return a.dataset.scType=s,a.dataset.scName=c,a}isJson(e){try{JSON.parse(e)}catch(e){return!1}return!0}createList(e,t){let s=document.createElement("ul"),a=this.toFilesFolders(e);return s.dataset.scChildren="",a.folders.forEach(e=>{let a=this.append(t,e,"folder");s.appendChild(a)}),a.files.forEach(e=>{let a=this.append(t,e,"file");s.appendChild(a)}),s}createLi(e){let t=document.createElement("li"),s=document.createElement("div"),a=document.createElement("div"),c=document.createElement("div"),i=document.createTextNode(e);return a.classList.add("sc-icon"),c.classList.add("sc-name"),s.classList.add("sc-current"),c.appendChild(i),s.appendChild(a),s.appendChild(c),t.appendChild(s),t}toFilesFolders(e){let t=[];t.folders=[],t.files=[];let s=0;return e.forEach(e=>{this.isFolder(e)?t.folders[s]=e.slice(0,-1):t.files[s]=e,s++}),t.folders.sort(),t.files.sort(),t}isFolder(e){return"/"==e[e.length-1]}onClickName(e){e.addEventListener("click",e=>{let t=e.currentTarget.closest("li"),s=this.setData(t);this.removeActive(),this.setActive(t),this.callback("select",s)})}onClickToggle(e){e.addEventListener("click",e=>{let t=e.currentTarget.closest("li"),s=t.closest("li"),a=s.dataset.scState,c=this.setData(t);s.dataset.scState="open"==a?"close":"open",c.state=s.dataset.scState,this.callback("toggle",c)})}onClickFolder(e){e.addEventListener("click",e=>{let t=e.currentTarget.closest("[data-sc-name]");if(void 0===t.dataset.scChildren){let e=t.dataset.scName,s=this.trimSlashes(e);this.ajax(s)}})}ajaxClickName(e){let t=this.o.selector+'[data-sc-name="'+e+'"] > ul > li > .sc-current > .sc-name'+", "+(this.o.selector+' [data-sc-name="'+e+'"] > ul > li > .sc-current > .sc-name');this.$$(t).forEach(e=>{this.onClickName(e)})}ajaxClickToggle(e){let t=e.dataset.scName,s=this.$(this.o.selector+'[data-sc-name="'+t+'"] > .sc-current > .sc-icon,'+this.o.selector+' [data-sc-name="'+t+'"] > .sc-current > .sc-icon');s&&this.onClickToggle(s)}ajaxClickFolder(e){e.querySelectorAll('li[data-sc-type="folder"]:not([data-sc-children]) .sc-icon').forEach(e=>{this.onClickFolder(e)})}trimSlashes(e){return e.replace(/^\/+|\/+$/g,"")}setData(e){let t={};return t.id=e.dataset.scName,t.element=e,t.type=e.dataset.scType,t}removeActive(){this.$$(this.o.selector+" li").forEach(function(e){delete e.dataset.scActive})}setActive(e){e.dataset.scActive=""}}document.addEventListener("DOMContentLoaded",()=>{(new StaircaseCore).load()});